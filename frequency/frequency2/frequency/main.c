#include <reg51.h>
#include<intrins.h>
#include "lcd12864.h"
#include "hc165.h"
#include "uart.h"
/**************************************************************************/
sbit mod1=P1^0;//mod1:frequency , period
sbit mod2=P1^1;//mod2:interval
sbit mod3=P1^2;//mod3:duty
sbit start=P1^3;//send start signal
sbit sendbutton=P1^4;
sbit startout=P2^0;
sbit clrout=P2^1;
bit startflag=0;
bit read=0;
bit sendflag=0;
unsigned char keyvalue=0;
unsigned char counter=0;
unsigned long frequency11=0;
unsigned long time11=0;
unsigned long duty11=0;
extern unsigned long recievedat[4];
unsigned char dat[9]={0};
/**************************************************************************/
/**************************************************************************/
unsigned char code Photo[]={
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0xDE,0xC0,0x00,0x38,0x00,0x06,0xFF,0x00,0x06,0x00,0x06,0x0C,0x00,0x00,
0x00,0x00,0xFE,0xC0,0x00,0x18,0x00,0x16,0xFF,0x01,0xFF,0xF0,0x07,0x0C,0x00,0x00,
0x00,0x00,0x7D,0xF8,0x07,0xFF,0xC0,0x17,0xB0,0x01,0xFF,0xF0,0x03,0x0C,0x00,0x00,
0x00,0x00,0xFF,0xF8,0x06,0x00,0xC0,0x16,0xFE,0x00,0xCD,0xB0,0x00,0x0C,0x00,0x00,
0x00,0x00,0x7F,0xB0,0x07,0xFF,0xC0,0x3F,0xFE,0x00,0xFF,0xF0,0x0F,0x7F,0xC0,0x00,
0x00,0x00,0xFF,0xB0,0x00,0x0F,0x00,0x3F,0xD6,0x00,0x7F,0x60,0x0F,0x7F,0xC0,0x00,
0x00,0x00,0xBD,0xB0,0x00,0x1C,0x00,0x16,0xD6,0x00,0xFF,0xF0,0x03,0x0C,0x00,0x00,
0x00,0x00,0xFC,0xF0,0x07,0xFF,0xC0,0x1F,0xD6,0x01,0xDF,0xB8,0x03,0x0C,0x00,0x00,
0x00,0x00,0xFC,0xE0,0x07,0xFF,0xC0,0x37,0xD6,0x00,0x06,0x80,0x03,0x0C,0x00,0x00,
0x00,0x00,0xEC,0x60,0x00,0x18,0x00,0x37,0xFE,0x01,0xFF,0xF8,0x03,0x4C,0x00,0x00,
0x00,0x00,0x7D,0xF0,0x00,0x18,0x00,0x2E,0x7C,0x00,0x06,0x00,0x03,0xCC,0x00,0x00,
0x00,0x00,0xFF,0xB8,0x00,0xF8,0x00,0x3D,0xEF,0x00,0x06,0x00,0x03,0x8C,0x00,0x00,
0x00,0x00,0xE3,0x18,0x00,0xF0,0x00,0x39,0x83,0x00,0x06,0x00,0x02,0x0C,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x90,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x90,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x90,0x02,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x90,0x02,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x05,0xB0,0x02,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x41,0x05,0xB0,0x42,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x41,0x05,0xB0,0x43,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x20,0x41,0x05,0xB0,0x43,0x02,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x20,0x41,0x05,0xB4,0xC3,0x02,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x08,0x21,0x49,0x0D,0xB6,0xDB,0x86,0x10,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x08,0x21,0x6B,0x0D,0xB6,0xDB,0x86,0x10,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x20,0x08,0x61,0x6B,0x0D,0xB6,0xDB,0x86,0x18,0x02,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x08,0x61,0x6B,0x0D,0xB6,0xDB,0xC6,0x18,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x62,0x1C,0x61,0xEF,0x2D,0xB6,0xDB,0xC6,0x18,0x42,0x00,0x00,0x00,
0x00,0x00,0x00,0x62,0x1C,0x65,0xEF,0xAF,0xF6,0xDB,0xD6,0x18,0x46,0x00,0x00,0x00,
0x00,0x00,0x00,0x72,0x1D,0x65,0xEF,0xEF,0xF6,0xFB,0xD7,0xD8,0x66,0x00,0x00,0x00,
0x00,0x01,0x08,0x53,0x57,0xFD,0xFF,0xEF,0xF6,0xFB,0xF7,0xDF,0x6F,0x18,0x00,0x00,
0x00,0x00,0x59,0x53,0x57,0xFF,0xBE,0xFF,0xFE,0xEB,0xF5,0xDF,0x6B,0x5A,0x08,0x00,
0x00,0x01,0x5D,0x5F,0xF6,0xFF,0xBE,0xFB,0x7F,0xAF,0xFD,0xF7,0xE9,0xDB,0x40,0x00,
0x00,0x01,0x17,0xCF,0xF6,0x9B,0xB6,0xDB,0x7F,0xAF,0xFD,0x75,0xA9,0xDA,0x00,0x00,
0x00,0x00,0x04,0xCD,0xB6,0x1B,0xB6,0xDB,0x6D,0xAD,0xDC,0x25,0xB9,0x50,0x00,0x00,
0x00,0x00,0x00,0x0D,0x86,0x1B,0xB2,0xDB,0x6D,0x2D,0xD8,0x21,0xB0,0x00,0x00,0x00,
0x00,0x00,0x00,0x04,0x86,0x18,0xB0,0xDB,0x69,0x0C,0x88,0x20,0xB0,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x86,0x18,0xB0,0xDB,0x69,0x0C,0x88,0x20,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x04,0x04,0x18,0xB0,0xDA,0x69,0x0C,0x88,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x04,0x18,0xB0,0x92,0x49,0x04,0x88,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x18,0x30,0x12,0x49,0x04,0x08,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x10,0x30,0x12,0x41,0x04,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x02,0x40,0x04,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x02,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
unsigned char code show1[]={"模式: "};
unsigned char code show2[]={"周期频率"};
unsigned char code show3[]={"时间间隔"};
unsigned char code show4[]={"占空比  "};
unsigned char code show5[]={"停止测量"};
unsigned char code show6[]={"开始测量"};
unsigned char code unit1[]={"Hz"};
/**************************************************************************/
void delay1s(void);
void display1(unsigned char k);//mod display
void display2(unsigned char k);//unit state display
void display3(unsigned char k);//data dispaly
void keyscan();
void timedisplay();
void frequencydisplay();
void dutydisplay();
void datatrans(unsigned char k);
void FPGA_Init();
void sendmessage(unsigned char k);
void main()
{
	LCD12864_DrowPic(&Photo[0]);
	delay1s();
	FPGA_Init();
	LCD12864_Init();	
	InitUart();
	while(1)
	{
		keyscan();
		display1(keyvalue);
		display2(keyvalue);
		if(startflag)
		{
			clrout=1;
			_nop_();
			_nop_();
			_nop_();
			clrout=0;
			startout=1;
			delay1s();
			startout=0;
			HC165();
			read=1;
			if(read)
			{
				display3(keyvalue);
				read=0;
			}
		}
	}
	/********************************test***********************//*
		FPGA_Init();
	LCD12864_Init();
		while(1)
	{
		clrout=1;
		_nop_();
		_nop_();
		_nop_();
		clrout=0;
		startout=1;
		delay1s();
		startout=0;
	  HC165();
		datatrans(0);
		LCD12864_SetWindow(0,0);
		for(i=0;i<10;i++)
		{
			LCD12864_WriteData('0'+dat[i]);
		}
		LCD12864_WriteData('a');
	}
	/********************************test***********************/
}
void display1(unsigned char k)
{
	unsigned char i;
	LCD12864_SetWindow(0,0);
	for(i=0;show1[i]!='\0';i++)//show1[]={"模式:"};
	{
		LCD12864_WriteData(show1[i]);
	}
	switch(k)
	{
		case 2:
		{
			LCD12864_SetWindow(0,3);
				for(i=0;show3[i]!='\0';i++)//show3[]={"时间间隔"};
				{
					LCD12864_WriteData(show3[i]);
				}
		}break;
		case 3:
		{
			LCD12864_SetWindow(0,3);
				for(i=0;show4[i]!='\0';i++)//show4[]={"占空比"};
				{
					LCD12864_WriteData(show4[i]);
				}
		}break;
		default:
		{
			LCD12864_SetWindow(0,3);
				for(i=0;show2[i]!='\0';i++)//show2[]={"周期频率"};
				{
					LCD12864_WriteData(show2[i]);
				}
		}
	}
}
void display2(unsigned char k)
{
	unsigned char i;
	if(startflag)
	{
		LCD12864_SetWindow(1,2);
		for(i=0;show6[i]!='\0';i++)//show5[]={"开始测量"};
		{
			LCD12864_WriteData(show6[i]);
		}
		switch(k)
		{
			case 2:
			{
				LCD12864_SetWindow(2,7);
				LCD12864_WriteData(' ');
				LCD12864_WriteData(' ');
			}break;
			case 3:
			{
				LCD12864_SetWindow(2,7);
					LCD12864_WriteData('%');
				LCD12864_WriteData(' ');
				LCD12864_SetWindow(3,7);
				LCD12864_WriteData(' ');
				LCD12864_WriteData(' ');
			}break;
			default:
			{
				LCD12864_SetWindow(2,7);
				for(i=0;unit1[i]!='\0';i++)//unit1[]={"Hz"};
				{
					LCD12864_WriteData(unit1[i]);
				}
			}
		}
	}
	if(!startflag)
	{
		LCD12864_SetWindow(1,2);
		for(i=0;show5[i]!='\0';i++)//show5[]={"停止测量"};
		{
			LCD12864_WriteData(show5[i]);
		}
	}
}
void display3(unsigned char k)
{
	LCD12864_SetWindow(2,0);
	datatrans(k);
		switch(k)
	{
		case 2://ms
		{
			timedisplay();
		}break;
		case 3:
		{
			dutydisplay();
		}break;
		default:
		{
			frequencydisplay();
			timedisplay();
		}
	}
}
void timedisplay()
{
		unsigned char i;
		unsigned char dat[10];
		bit zeroflag=0;
		dat[0]=time11/100000000;
		dat[1]=time11%100000000/10000000;
		dat[2]=time11%10000000/1000000;
		dat[3]=time11%1000000/100000;
		dat[4]=time11%100000/10000;
		dat[5]=time11%10000/1000;
		dat[6]=time11%1000/100;
		dat[7]=time11%100/10;
		dat[8]=time11%10;
		LCD12864_SetWindow(3,0);
			if(time11>=100000000)
			{zeroflag=0;
				for(i=0;i<1;i++)
				{
					if(dat[i]==0&&!zeroflag)
						{
							LCD12864_WriteData(' ');
						}
						else
						{
							LCD12864_WriteData('0'+dat[i]);
							zeroflag=1;
						}
				}
				LCD12864_WriteData('.');
				for(i=1;i<9;i++)
				{
					LCD12864_WriteData('0'+dat[i]);
				}
				LCD12864_SetWindow(3,7);
				LCD12864_WriteData(' ');
				LCD12864_WriteData('s');
			}
			if((time11<100000000)&&(time11>=100000))
			{
				zeroflag=0;
				for(i=1;i<4;i++)
				{
					if(dat[i]==0&&!zeroflag)
						{
							LCD12864_WriteData(' ');
						}
						else
						{
							LCD12864_WriteData('0'+dat[i]);
							zeroflag=1;
						}
				}
				LCD12864_WriteData('.');
				for(i=4;i<9;i++)
				{
					LCD12864_WriteData('0'+dat[i]);
				}
				LCD12864_SetWindow(3,7);
				LCD12864_WriteData('m');
				LCD12864_WriteData('s');
			}
			if(time11<100000&&(time11>=100))
			{
				zeroflag=0;
				for(i=4;i<7;i++)
				{
						if(dat[i]==0&&!zeroflag)
						{
							LCD12864_WriteData(' ');
						}
						else
						{
							LCD12864_WriteData('0'+dat[i]);
							zeroflag=1;
						}
				}
				LCD12864_WriteData('.');
				for(i=7;i<9;i++)
				{
					LCD12864_WriteData('0'+dat[i]);
				}
				LCD12864_SetWindow(3,7);
				LCD12864_WriteData('u');
				LCD12864_WriteData('s');
			}
			if(time11<100)
			{
				zeroflag=0;
				for(i=7;i<9;i++)
				{
							LCD12864_WriteData('0'+dat[i]);
				}
				LCD12864_WriteData('0');
				LCD12864_SetWindow(3,7);
				LCD12864_WriteData('n');
				LCD12864_WriteData('s');
			}
}
void frequencydisplay()
{
			unsigned char i;
			bit zeroflag=0;
			LCD12864_SetWindow(2,0);
				if(frequency11<1000)
				{
					zeroflag=0;
					for(i=6;i<9;i++)
					{
						if(dat[i]==0&&!zeroflag)
						{
							LCD12864_WriteData(' ');
						}
						else
						{
							LCD12864_WriteData('0'+dat[i]);
							if(sendflag)
							{
								SendData('0'+dat[i]);
							}
							zeroflag=1;
						}
					}
					LCD12864_SetWindow(2,6);
					LCD12864_WriteData(' ');
					LCD12864_WriteData(' ');
				}
				if((frequency11>=1000)&&(frequency11<1000000))
				{
					zeroflag=0;
					for(i=3;i<6;i++)
					{
						if(dat[i]==0&&!zeroflag)
						{
							LCD12864_WriteData(' ');
						}
						else
						{
							LCD12864_WriteData('0'+dat[i]);
							if(sendflag)
							{
								SendData('0'+dat[i]);
							}
							zeroflag=1;
						}
					}
					LCD12864_WriteData('.');
					if(sendflag)
							{
								SendData('.');
							}
					for(i=6;i<9;i++)
					{
						 LCD12864_WriteData('0'+dat[i]);
						if(sendflag)
							{
								SendData('0'+dat[i]);
							}
					}
					LCD12864_SetWindow(2,6);
					LCD12864_WriteData(' ');
					LCD12864_WriteData('K');
					if(sendflag)
							{
								SendData('K');
							}
				}
				if(frequency11>=1000000)
				{
					zeroflag=0;
					for(i=0;i<3;i++)
					{
						if(dat[i]==0&&!zeroflag)
						{
							LCD12864_WriteData(' ');
						}
						else
						{
							LCD12864_WriteData('0'+dat[i]);
							if(sendflag)
							{
								SendData('0'+dat[i]);
							}
							zeroflag=1;
						}
					}
					LCD12864_WriteData('.');
					if(sendflag)
							{
								SendData('.');
							}
					for(i=3;i<9;i++)
					{
						LCD12864_WriteData('0'+dat[i]);
						if(sendflag)
							{
								SendData('0'+dat[i]);
							}
					}
					LCD12864_SetWindow(2,6);
					LCD12864_WriteData(' ');
					LCD12864_WriteData('M');
					if(sendflag)
							{
								SendData('M');
							}
				}
					if(sendflag)
							{
								SendData('H');
								SendData('z');
							}
}
void dutydisplay()
{
	unsigned char i;
	bit zeroflag=0;
	LCD12864_SetWindow(2,4);
	for(i=0;i<3;i++)
	{
		if(dat[i]==0&&!zeroflag)
		{
			LCD12864_WriteData(' ');
		}
		else
		{
			LCD12864_WriteData('0'+dat[i]);
			zeroflag=1;
		}
	}
	LCD12864_WriteData('.');
	for(i=3;i<4;i++)
	{
		if(dat[i]==0&&!zeroflag)
		{
			LCD12864_WriteData(' ');
		}
		else
		{
			LCD12864_WriteData('0'+dat[i]);
			zeroflag=1;
		}
	}
}
void datatrans(unsigned char k)
{
	switch(k)
		{
			case 2://unit2[]={"ms"};
			{
				time11=((float)(recievedat[0])/(float)(recievedat[2]))/2;
			}break;
			case 3://duty
			{
				duty11=((float)(recievedat[3])/(float)(recievedat[1]))*10000;
					dat[0]=duty11/10000;
					dat[1]=duty11%10000/1000;
					dat[2]=duty11%1000/100;
					dat[3]=duty11%100/10;
			}break;
			default://Hz
			{
				frequency11=((float)(recievedat[2])/(float)(recievedat[1]))*100000000;
					dat[0]=frequency11/100000000;
					dat[1]=frequency11%100000000/10000000;
					dat[2]=frequency11%10000000/1000000;
					dat[3]=frequency11%1000000/100000;
					dat[4]=frequency11%100000/10000;
					dat[5]=frequency11%10000/1000;
					dat[6]=frequency11%1000/100;
					dat[7]=frequency11%100/10;
					dat[8]=frequency11%10;
				time11=((float)(recievedat[1])/(float)(recievedat[2]))+1;
			}
		}
}
void keyscan()
{
	if(!mod1)
	{
		while(!mod1);
			keyvalue=1;
	}
	if(!mod2)
	{
		while(!mod2);
			keyvalue=2;
	}
	if(!mod3)
	{
		while(!mod3);
			keyvalue=3;
	}
	if(!start)
	{
		while(!start);
			startflag=!startflag;
		LCD12864_WriteCmd(0x01);
			if(startflag)
			{
					startout=1;
			}
	}
	if(!sendbutton)
	{
		while(!sendbutton);
		sendflag=!sendflag;
		LCD12864_WriteCmd(0x01);
	}
}
void FPGA_Init()
{
	clrout=0;
	startout=0;
	HC165_nPL=1;
	HC165_OUT=1;
	HC165_CK=0;
}
void delay1s(void)   //?? -0.000000000056us
{
    unsigned char a,b,c;
    for(c=71;c>0;c--)
        for(b=168;b>0;b--)
            for(a=250;a>0;a--);
}