#include <reg51.h>
#include "lcd12864.h"
#include "hc165.h"
/**************************************************************************/
sbit mod1=P1^0;//mod1:frequency , period
sbit mod2=P1^1;//mod2:interval
sbit mod3=P1^2;//mod3:duty
sbit start=P1^3;//send start signal
sbit clr=P1^4;//send clear signal
sbit startout=P2^0;
sbit clrout=P2^1;
bit ready_to_read=0;
bit startflag=0;
bit clrflag=0;
unsigned char keyvalue=0;
unsigned char timercount=0;
extern unsigned char recievedat[16];
/**************************************************************************/
/**************************************************************************/
unsigned char code Photo[]={
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0xDE,0xC0,0x00,0x38,0x00,0x06,0xFF,0x00,0x06,0x00,0x06,0x0C,0x00,0x00,
0x00,0x00,0xFE,0xC0,0x00,0x18,0x00,0x16,0xFF,0x01,0xFF,0xF0,0x07,0x0C,0x00,0x00,
0x00,0x00,0x7D,0xF8,0x07,0xFF,0xC0,0x17,0xB0,0x01,0xFF,0xF0,0x03,0x0C,0x00,0x00,
0x00,0x00,0xFF,0xF8,0x06,0x00,0xC0,0x16,0xFE,0x00,0xCD,0xB0,0x00,0x0C,0x00,0x00,
0x00,0x00,0x7F,0xB0,0x07,0xFF,0xC0,0x3F,0xFE,0x00,0xFF,0xF0,0x0F,0x7F,0xC0,0x00,
0x00,0x00,0xFF,0xB0,0x00,0x0F,0x00,0x3F,0xD6,0x00,0x7F,0x60,0x0F,0x7F,0xC0,0x00,
0x00,0x00,0xBD,0xB0,0x00,0x1C,0x00,0x16,0xD6,0x00,0xFF,0xF0,0x03,0x0C,0x00,0x00,
0x00,0x00,0xFC,0xF0,0x07,0xFF,0xC0,0x1F,0xD6,0x01,0xDF,0xB8,0x03,0x0C,0x00,0x00,
0x00,0x00,0xFC,0xE0,0x07,0xFF,0xC0,0x37,0xD6,0x00,0x06,0x80,0x03,0x0C,0x00,0x00,
0x00,0x00,0xEC,0x60,0x00,0x18,0x00,0x37,0xFE,0x01,0xFF,0xF8,0x03,0x4C,0x00,0x00,
0x00,0x00,0x7D,0xF0,0x00,0x18,0x00,0x2E,0x7C,0x00,0x06,0x00,0x03,0xCC,0x00,0x00,
0x00,0x00,0xFF,0xB8,0x00,0xF8,0x00,0x3D,0xEF,0x00,0x06,0x00,0x03,0x8C,0x00,0x00,
0x00,0x00,0xE3,0x18,0x00,0xF0,0x00,0x39,0x83,0x00,0x06,0x00,0x02,0x0C,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x90,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x90,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x90,0x02,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x90,0x02,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x05,0xB0,0x02,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x41,0x05,0xB0,0x42,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x41,0x05,0xB0,0x43,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x20,0x41,0x05,0xB0,0x43,0x02,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x20,0x41,0x05,0xB4,0xC3,0x02,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x08,0x21,0x49,0x0D,0xB6,0xDB,0x86,0x10,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x08,0x21,0x6B,0x0D,0xB6,0xDB,0x86,0x10,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x20,0x08,0x61,0x6B,0x0D,0xB6,0xDB,0x86,0x18,0x02,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x08,0x61,0x6B,0x0D,0xB6,0xDB,0xC6,0x18,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x62,0x1C,0x61,0xEF,0x2D,0xB6,0xDB,0xC6,0x18,0x42,0x00,0x00,0x00,
0x00,0x00,0x00,0x62,0x1C,0x65,0xEF,0xAF,0xF6,0xDB,0xD6,0x18,0x46,0x00,0x00,0x00,
0x00,0x00,0x00,0x72,0x1D,0x65,0xEF,0xEF,0xF6,0xFB,0xD7,0xD8,0x66,0x00,0x00,0x00,
0x00,0x01,0x08,0x53,0x57,0xFD,0xFF,0xEF,0xF6,0xFB,0xF7,0xDF,0x6F,0x18,0x00,0x00,
0x00,0x00,0x59,0x53,0x57,0xFF,0xBE,0xFF,0xFE,0xEB,0xF5,0xDF,0x6B,0x5A,0x08,0x00,
0x00,0x01,0x5D,0x5F,0xF6,0xFF,0xBE,0xFB,0x7F,0xAF,0xFD,0xF7,0xE9,0xDB,0x40,0x00,
0x00,0x01,0x17,0xCF,0xF6,0x9B,0xB6,0xDB,0x7F,0xAF,0xFD,0x75,0xA9,0xDA,0x00,0x00,
0x00,0x00,0x04,0xCD,0xB6,0x1B,0xB6,0xDB,0x6D,0xAD,0xDC,0x25,0xB9,0x50,0x00,0x00,
0x00,0x00,0x00,0x0D,0x86,0x1B,0xB2,0xDB,0x6D,0x2D,0xD8,0x21,0xB0,0x00,0x00,0x00,
0x00,0x00,0x00,0x04,0x86,0x18,0xB0,0xDB,0x69,0x0C,0x88,0x20,0xB0,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x86,0x18,0xB0,0xDB,0x69,0x0C,0x88,0x20,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x04,0x04,0x18,0xB0,0xDA,0x69,0x0C,0x88,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x04,0x18,0xB0,0x92,0x49,0x04,0x88,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x18,0x30,0x12,0x49,0x04,0x08,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x10,0x30,0x12,0x41,0x04,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x02,0x40,0x04,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x20,0x02,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00};
unsigned char code show1[]={"模式: "};
unsigned char code show2[]={"周期频率"};
unsigned char code show3[]={"时间间隔"};
unsigned char code show4[]={"占空比  "};
unsigned char code show5[]={"停止测量"};
unsigned char code show6[]={"开始测量"};
unsigned char code unit1[]={"Hz"};
unsigned char code unit2[]={"ms"};
/**************************************************************************/
void Delay10ms(unsigned int c);
void display1(unsigned char k);
void display2(unsigned char k);
void keyscan();
void interrupt2on();
void main()
{
	LCD12864_DrowPic(&Photo[0]);
	Delay10ms(1000);	
	LCD12864_Init();
	interrupt2on();
	while(1)
	{
		keyscan();
		display1(keyvalue);
		display2(keyvalue);
	}
}
void display1(unsigned char k)
{
	unsigned char i;
	LCD12864_SetWindow(0,0);
	for(i=0;show1[i]!='\0';i++)//show1[]={"模式:"};
	{
		LCD12864_WriteData(show1[i]);
	}
	switch(k)
	{
		case 2:
		{
			LCD12864_SetWindow(0,3);
				for(i=0;show3[i]!='\0';i++)//show3[]={"时间间隔"};
				{
					LCD12864_WriteData(show3[i]);
				}
		}break;
		case 3:
		{
			LCD12864_SetWindow(0,3);
				for(i=0;show4[i]!='\0';i++)//show4[]={"占空比"};
				{
					LCD12864_WriteData(show4[i]);
				}
		}break;
		default:
		{
			LCD12864_SetWindow(0,3);
				for(i=0;show2[i]!='\0';i++)//show2[]={"周期频率"};
				{
					LCD12864_WriteData(show2[i]);
				}
		}
	}
}
void display2(unsigned char k)
{
	unsigned char i;
	if(startflag)
	{
		LCD12864_SetWindow(1,2);
		for(i=0;show6[i]!='\0';i++)//show5[]={"开始测量"};
		{
			LCD12864_WriteData(show6[i]);
		}
		switch(k)
		{
			case 2:
			{
				LCD12864_SetWindow(2,7);
				for(i=0;unit2[i]!='\0';i++)//unit2[]={"ms"};
				{
					LCD12864_WriteData(unit2[i]);
				}
				LCD12864_SetWindow(3,7);
				LCD12864_WriteData(' ');
				LCD12864_WriteData(' ');
			}break;
			case 3:
			{
				LCD12864_SetWindow(2,7);
					LCD12864_WriteData('%');
				LCD12864_WriteData(' ');
				LCD12864_SetWindow(3,7);
				LCD12864_WriteData(' ');
				LCD12864_WriteData(' ');
			}break;
			default:
			{
				LCD12864_SetWindow(2,7);
				for(i=0;unit1[i]!='\0';i++)//unit1[]={"KHz"};
				{
					LCD12864_WriteData(unit1[i]);
				}
				LCD12864_SetWindow(3,7);
				for(i=0;unit2[i]!='\0';i++)//unit2[]={"ms"};
				{
					LCD12864_WriteData(unit2[i]);
				}
			}
		}
	}
	if(!startflag)
	{
		LCD12864_SetWindow(1,2);
		for(i=0;show5[i]!='\0';i++)//show5[]={"停止测量"};
		{
			LCD12864_WriteData(show5[i]);
		}
		LCD12864_SetWindow(2,7);
		LCD12864_WriteData(' ');
		LCD12864_WriteData(' ');
		LCD12864_SetWindow(3,7);
		LCD12864_WriteData(' ');
		LCD12864_WriteData(' ');
	}
}
void keyscan()
{
	if(!mod1)
	{
		while(!mod1);
			keyvalue=1;
	}
	if(!mod2)
	{
		while(!mod2);
			keyvalue=2;
	}
	if(!mod3)
	{
		while(!mod3);
			keyvalue=3;
	}
	if(!start)
	{
		while(!start);
			startflag=!startflag;
			if(startflag)
			{
				startout=0;
				Delay10ms(1);
				startout=1;
			}
	}
	if(!clr)
	{
		while(!clr);
			clrflag=1;
			clrout=0;
			Delay10ms(1);
			clrout=1;
	}
}
void interrupt2on()
{
	EA=1;
	IT1 = 1;
	EX1=1;
}
void timer ()interrupt 1
{
	timercount++;
	if(timercount>=20)
	{
		timercount=0;
	}
}
void finish ()interrupt 2
{
//	HC165();
	ready_to_read=1;
}
void Delay10ms(unsigned int c)   
{
    unsigned char a, b;

    for (;c>0;c--)
	{
		for (b=38;b>0;b--)
		{
			for (a=130;a>0;a--);
		}
           
	}        
}