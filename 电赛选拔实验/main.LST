C51 COMPILER V9.52.0.0   MAIN                                                              05/17/2015 12:17:18 PAGE 1   


C51 COMPILER V9.52.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Program Files\keil\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          #include<reg52.h>
   2          //#include"temp.h"
   3          //#include"lcd.h"
   4          //#include"pcf8591.h"
   5          #include"ds1302.h"
   6          #include"i2c.h"
   7          #include<intrins.h>
   8          
   9          
  10          //--¶¨ÒåPCF8591µÄ¶ÁÐ´µØÖ·--//
  11          #define  WRITEADDR 0x90    //Ð´µØÖ·
  12          #define  READADDR  0x91    //¶ÁµØÖ·
  13          
  14          //--¶¨ÒåÈ«¾Ö±äÁ¿--//
  15          unsigned char code DIG_CODE[17]={
  16          0x3f,0x06,0x5b,0x4f,0x66,0x6d,0x7d,0x07,
  17          0x7f,0x6f,0x77,0x7c,0x39,0x5e,0x79,0x71};
  18          //0¡¢1¡¢2¡¢3¡¢4¡¢5¡¢6¡¢7¡¢8¡¢9¡¢A¡¢b¡¢C¡¢d¡¢E¡¢FµÄÏÔÊ¾Âë
  19          unsigned char DisplayData[8];
  20          //ÓÃÀ´´æ·ÅÒªÏÔÊ¾µÄ8Î»ÊýµÄÖµ
  21          
  22          //--ÉùÃ÷È«¾Öº¯Êý--//
  23          void DigDisplay(); //¶¯Ì¬ÏÔÊ¾º¯Êý
  24          void Pcf8591SendByte(unsigned char channel);
  25          unsigned char Pcf8591ReadByte();
  26          void Pcf8591DaConversion(unsigned char value);
  27          void DigDisplay();
  28          void LcdDisplayTemp0(int temp); 
  29          void LcdDisplay();
  30            unsigned char code p0[]="DATE:",
  31                               p1[]= "TIME:",
  32                               p2[]= "TEMP:",
  33                               p3[]="AD1:",
  34                               p4[]="Relay:";
  35          /******************************************************************************
  36          º¯ÊýÃû³Æ£ºDelay
  37          º¯Êý¹¦ÄÜ£ºÑÓÊ±º¯Êý
  38          Èë¿Ú²ÎÊý£ºuiCount-ÑÓÊ±²ÎÊý£¬Ã¿¼Ó1Ôö¼Ó0.5ms
  39          ·µ»ØÖµ£ºÎÞ
  40          ±¸×¢£ºÎÞ
  41          *******************************************************************************/
  42          void Delay(unsigned int uiCount)
  43          {
  44   1        unsigned char j = 244;
  45   1        for(;uiCount > 0;uiCount--) while(--j); 
  46   1      }
  47                               
  48          sbit LCD1602_RS = P2^6; //Î»¶¨Òå£¬Òº¾§µÄÊý¾Ý/ÃüÁîÑ¡Ôñ
  49          sbit LCD1602_RW = P2^5; //Î»¶¨Òå£¬Òº¾§µÄ¶ÁÐ´Ñ¡Ôñ
  50          sbit LCD1602_EN = P2^7; //Î»¶¨Òå£¬Òº¾§Ê¹ÄÜÐÅºÅ
  51          
  52          #define LCDPORT P0    //Òº¾§µÄÊý¾Ý¿Ú
  53          unsigned char  code Data[]={0x04,0x0f,0x12,0x0f,0x0a,0x1f,0x02,0x02,//Äê
  54                                      0x0f,0x09,0x0f,0x09,0x0f,0x09,0x09,0x13,//ÔÂ
  55                                      0x1f,0x11,0x11,0x1f,0x11,0x11,0xff,0x00,//ÈÕ
C51 COMPILER V9.52.0.0   MAIN                                                              05/17/2015 12:17:18 PAGE 2   

  56                                      0x0e,0x0a,0x0e,0x00,0x1f,0x11,0x11,0x1f,//ÂÀ
  57                                      0x04,0x1f,0x08,0x1f,0x09,0x0f,0x09,0x09,
  58                                      0x02,0x02,0x1f,0x06,0x0a,0x12,0x02,0x06,
  59                                      0x1c,0x14,0x1c,0x03,0x04,0x04,0x04,0x03//¡ãc
  60                         };
  61          
  62          /******************************************************************************
  63          º¯ÊýÃû³Æ£ºLCD1602_CheckBusy
  64          º¯Êý¹¦ÄÜ£ºÃ¦¼ì²â
  65          Èë¿Ú²ÎÊý£ºÎÞ
  66          ·µ»ØÖµ£ºÎÞ
  67          ±¸×¢£ºÃ¦¼ì²â²ÉÓÃÁË¶à¼ÓÒ»¸öÑÓÊ±Ìõ¼þµÄ°ì·¨£¬·ÅÖÃ³ÌÐò¿¨ÔÚ¼ì²âº¯ÊýÖÐ
  68          *******************************************************************************/
  69          void LCD1602_CheckBusy(void)    
  70          {
  71   1        unsigned char i = 255;
  72   1        LCDPORT = 0xFF;  //¶ÁÖ®Ç°ÏÈÖÃÎ»£¬×¼±¸¶ÁÈ¡IO¿ÚÊý¾Ý
  73   1        LCD1602_RS = 0;
  74   1        LCD1602_RW = 1;  //Ê¹Òº¾§´¦ÓÚ¶ÁÊý¾Ý×´Ì¬
  75   1        LCD1602_EN = 1;  //Ê¹ÄÜÒº¾§£¬¸ßµçÆ½ÓÐÐ§
  76   1        while((i--) && (LCDPORT & 0x80)); //Ã¦¼ì²â
  77   1        LCD1602_EN = 0;
  78   1      }
  79          
  80          /******************************************************************************
  81          º¯ÊýÃû³Æ£ºLCD1602_WriteInformation
  82          º¯Êý¹¦ÄÜ£ºÏòLCD1602Òº¾§Ð´ÈëÊý¾Ý»òÕßÃüÁî
  83          Èë¿Ú²ÎÊý£ºucData-ÒªÐ´ÈëµÄÊý¾Ý»òÕßÃüÁî²ÎÊý
  84                bComOrData-Îª0Ê±Ð´ÈëµÄÊ±ÃüÁî£¬Îª1Ê±Ð´ÈëµÄÊ±Êý¾Ý
  85          ·µ»ØÖµ£ºÎÞ
  86          ±¸×¢£ºÎÞ
  87          *******************************************************************************/
  88          void LCD1602_WriteInformation(unsigned char ucData,bit bComOrData)   
  89          {
  90   1        LCD1602_CheckBusy();   //ÔÚÐ´ÈëÊý¾Ý»òÕßÃüÁîÇ°ÏÈ½øÐÐÃ¦¼ì²â
  91   1        LCDPORT = ucData;    //ÏÈ½«Êý¾Ý»òÕßÃüÁîËÍÖÁIO
  92   1        LCD1602_RS = bComOrData;  //È·¶¨ÊÇÐ´ÈëÊý¾Ý»¹ÊÇÐ´ÃüÁî
  93   1        LCD1602_RW = 0;   //Ê¹Òº¾§´¦ÓÚÐ´ÈëÐÅÏ¢×´Ì¬
  94   1        LCD1602_EN = 1;   //Ê¹ÄÜÒº¾§£¬¸ßµçÆ½ÓÐÐ§
  95   1        LCD1602_EN = 0;
  96   1      }
  97          
  98          /******************************************************************************
  99          º¯ÊýÃû³Æ£ºLCD1602_Init
 100          º¯Êý¹¦ÄÜ£ºÒº¾§³õÊ¼»¯º¯Êý
 101          Èë¿Ú²ÎÊý£ºÎÞ
 102          ·µ»ØÖµ£ºÎÞ
 103          ±¸×¢£ºÎÞ
 104          *******************************************************************************/
 105          void LCD1602_Init()    
 106          {
 107   1        unsigned char i;
 108   1        LCD1602_WriteInformation(0x38,0);
 109   1        Delay(300);
 110   1        LCD1602_WriteInformation(0x38,0);
 111   1        Delay(100);
 112   1        LCD1602_WriteInformation(0x38,0);
 113   1        Delay(100);
 114   1        LCD1602_WriteInformation(0x38,0);   //Ð´ÈëÃüÁî£¬5x7µãÕó¹¤×÷·½Ê½£¬8Î»Êý¾Ý½Ó¿Ú
 115   1        Delay(100);
 116   1        LCD1602_WriteInformation(0x0c,0); //ÏÔÊ¾ÉèÖÃ£¬¿ªÏÔÊ¾£¬¹â±ê²»ÏÔÊ¾£¬²»ÉÁË¸//        £¨Îª0Ê±·ñ£©
 117   1        Delay(20);
C51 COMPILER V9.52.0.0   MAIN                                                              05/17/2015 12:17:18 PAGE 3   

 118   1        LCD1602_WriteInformation(0x01,0); //ÇåÆÁÖ¸Áî
 119   1        Delay(20);
 120   1        LCD1602_WriteInformation(0x40,0); 
 121   1        for(i=0;i<64;i++)
 122   1        {
 123   2            LCD1602_WriteInformation(Data[i],1);  
 124   2        }
 125   1      }
 126            
 127          /******************************************************************************
 128          º¯ÊýÃû³Æ£ºLCD1602_MoveToPosition
 129          º¯Êý¹¦ÄÜ£º½«Òº¾§µÄ¹â±êÒÆ¶¯µ½Ö¸¶¨µÄÎ»ÖÃ
 130          Èë¿Ú²ÎÊý£ºx-Òº¾§ÏÔÊ¾µÄÐÐÊý£¬·¶Î§0-1
 131                x = 0:ÔÚÒº¾§µÄµÚÒ»ÐÐ
 132                x = 1:ÔÚÒº¾§µÄµÚ¶þÐÐ
 133                y-Òº¾§ÏÔÊ¾µÄÁÐÊý£¬·¶Î§0-15
 134                  y = 0:ÔÚÒº¾§µÄµÚÒ»ÁÐ
 135                y = 1:ÔÚÒº¾§µÄµÚ¶þÁÐ
 136                ......
 137                y = 15:ÔÚÒº¾§µÄµÚÊ®ÁùÁÐ
 138          ·µ»ØÖµ£ºÎÞ
 139          ±¸×¢£ºÍ¨¹ýÖ¸¶¨x,yµÄÖµ¿ÉÒÔ½«Òº¾§µÄ¹â±êÒÆ¶¯µ½Ö¸¶¨µÄÎ»ÖÃ
 140          *******************************************************************************/
 141          void LCD1602_MoveToPosition(unsigned char x,unsigned char y)  
 142          {
 143   1        if(0 == x)
 144   1          LCD1602_WriteInformation((0x80 | y),0);    //¹â±ê¶¨Î»µ½µÚÒ»ÐÐµÄyÁÐ
 145   1        if(1 == x)
 146   1          LCD1602_WriteInformation((0xC0 | y),0);    //¹â±ê¶¨Òåµ½µÚ¶þÐÐµÄyÁÐ
 147   1      }
 148          
 149          /******************************************************************************
 150          º¯ÊýÃû³Æ£ºLCD1602_DisplayOneCharOnAddr
 151          º¯Êý¹¦ÄÜ£ºÔÚÖ¸¶¨µÄÎ»ÖÃÉÏÏÔÊ¾Ö¸¶¨µÄ×Ö·û
 152          Èë¿Ú²ÎÊý£ºx-Òº¾§ÏÔÊ¾µÄÐÐÊý£¬·¶Î§0-1
 153                x = 0:ÔÚÒº¾§µÄµÚÒ»ÐÐ
 154                x = 1:ÔÚÒº¾§µÄµÚ¶þÐÐ
 155                y-Òº¾§ÏÔÊ¾µÄÁÐÊý£¬·¶Î§0-15
 156                  y = 0:ÔÚÒº¾§µÄµÚÒ»ÁÐ
 157                y = 1:ÔÚÒº¾§µÄµÚ¶þÁÐ
 158                ......
 159                y = 15:ÔÚÒº¾§µÄµÚÊ®ÁùÁÐ
 160                ucData-ÒªÏÔÊ¾µÄ×Ö·ûÊý¾Ý
 161          ·µ»ØÖµ£ºÎÞ
 162          ±¸×¢£ºÈ·±£x,yµÄÈ¡ÖµÒªÔÚÖ¸¶¨µÄ·¶Î§ÄÚ
 163          *******************************************************************************/
 164          void LCD1602_DisplayOneCharOnAddr(unsigned char x,unsigned char y,unsigned char ucData)
 165          {
 166   1        LCD1602_MoveToPosition(x,y);   //¹â±êÎ»ÖÃ
 167   1        LCD1602_WriteInformation(ucData,1);   //Ð´ÈëÊý¾Ý
 168   1      }
 169          
 170          /******************************************************************************
 171          º¯ÊýÃû³Æ£ºLCD1602_DisplayString
 172          º¯Êý¹¦ÄÜ£ºÏÔÊ¾×Ö·û´®
 173          Èë¿Ú²ÎÊý£ºucStr-×Ö·û´®µÄÊ×µØÖ·
 174          ·µ»ØÖµ£ºÎÞ
 175          ±¸×¢£ºÎÞ
 176          *******************************************************************************/
 177          void LCD1602_DisplayString(unsigned char *ucStr)  
 178          {
 179   1        while(*ucStr != '\0')    //×Ö·û´®½áÊøÖ®Ç°£¬Ñ­»·ÏÔÊ¾
C51 COMPILER V9.52.0.0   MAIN                                                              05/17/2015 12:17:18 PAGE 4   

 180   1        {
 181   2           LCD1602_WriteInformation(*ucStr,1);   //ÒÀ´ÎÐ´ÈëÃ¿Ò»¸ö×Ö·û
 182   2           ucStr++;                //Ö¸ÕëÔö¼Ó
 183   2        }
 184   1      }
 185          
 186          /******************************************************************************
 187          º¯ÊýÃû³Æ£ºDelay
 188          º¯Êý¹¦ÄÜ£ºÑÓÊ±º¯Êý
 189          Èë¿Ú²ÎÊý£ºuiCount-ÑÓÊ±²ÎÊý£¬Ã¿¼Ó1Ôö¼Ó0.5ms
 190          ·µ»ØÖµ£ºÎÞ
 191          ±¸×¢£ºÎÞ
 192          *******************************************************************************/
 193          
 194          #ifndef __TEMP_H_
 195          #define __TEMP_H_
 196          
 197          //---ÖØ¶¨Òå¹Ø¼ü´Ê---//
 198          #ifndef uchar
              #define uchar unsigned char
              #endif
 201          
 202          #ifndef uint 
              #define uint unsigned int
              #endif
 205          
 206          //--¶¨ÒåÊ¹ÓÃµÄIO¿Ú--//
 207          sbit DSPORT=P3^7;
 208          
 209          //--ÉùÃ÷È«¾Öº¯Êý--//
 210           void Delay1ms(uint );
 211          uchar Ds18b20Init();
 212           void Ds18b20WriteByte(uchar com);
 213          uchar Ds18b20ReadByte();
 214          void  Ds18b20ChangTemp();
 215          void  Ds18b20ReadTempCom();
 216          int Ds18b20ReadTemp();
 217          //sbit LCD1602_RS = P2^6; //Î»¶¨Òå£¬Òº¾§µÄÊý¾Ý/ÃüÁîÑ¡Ôñ
 218          //sbit LCD1602_RW = P2^5; //Î»¶¨Òå£¬Òº¾§µÄ¶ÁÐ´Ñ¡Ôñ
 219          //sbit LCD1602_EN = P2^7; //Î»¶¨Òå£¬Òº¾§Ê¹ÄÜÐÅºÅ
 220          
 221          #define LCDPORT P0    //Òº¾§µÄÊý¾Ý¿Ú
 222          
 223          //unsigned char code ucForum[]=" bbs.cepark.com ";    //ÔÚCODEÇø¶¨ÒåÒ»¸öÓÃÓÚÏÔÊ¾µÄ³£Á¿×Ö·û´®
 224          
 225          /*extern void Delay(unsigned int uiCount);  //ÑÓÊ±º¯Êý
 226          extern void LCD1602_CheckBusy(void);  //Òº¾§Ã¦¼ì²â
 227          extern void LCD1602_WriteInformation(unsigned char ucData,bit bComOrData);  //ÔÚÒº¾§ÉÏÐ´Êý¾Ý»òÕßÐ´ÃüÁî£¬0Îª
             -ÃüÁî£¬1ÎªÊý¾Ý
 228          extern void LCD1602_Init(); //Òº¾§³õÊ¼»¯
 229          extern void LCD1602_MoveToPosition(unsigned char x,unsigned char y);  //Òº¾§µÄ×ø±êÒÆ¶¯µ½Ö¸¶¨Î»ÖÃ
 230          extern void LCD1602_DisplayOneCharOnAddr(unsigned char x,unsigned char y,unsigned char ucData); //ÔÚÒº¾§Ö¸
             -¶¨Î»ÖÃÏÔÊ¾×Ö·û
 231          extern void LCD1602_DisplayString(unsigned char *ucStr);  //ÔÚÒº¾§ÉÏÏÔÊ¾×Ö·û´®
 232          */
 233          //extern void LCD1602_WriteInformation(unsigned char ucData,bit bComOrData);  //ÔÚÒº¾§ÉÏÐ´Êý¾Ý»òÕßÐ´ÃüÁî£¬0
             -ÎªÃüÁî£¬1ÎªÊý¾Ý
 234          void Pcf8591SendByte(unsigned char channel);
 235          unsigned char Pcf8591ReadByte();
 236          void Pcf8591DaConversion(unsigned char value);
 237          void pcf8591Play();
 238          extern   int  Ds18b20ReadTemp();  //¶ÁÈ¡ÎÂ¶È
C51 COMPILER V9.52.0.0   MAIN                                                              05/17/2015 12:17:18 PAGE 5   

 239          unsigned char Time0[9],week[3],week0,DisplayData[8], Data0[5],ADData[8];
 240          unsigned char code Seg_Data[]={  //the information is showed in the digital tube,shows 0-F//¹²ÑôÊýÂë¹ÜµÄ±à
             -Âë£¬²¢½«Êý¾Ý¶¨ÒåÔÚCODEÇø 
 241                            0xc0,/*0*/
 242                            0xF9,/*1*/
 243                            0xA4,/*2*/
 244                            0xB0,/*3*/
 245                            0x99,/*4*/
 246                            0x92,/*5*/
 247                            0x82,/*6*/
 248                            0xF8,/*7*/
 249                            0x80,/*8*/
 250                            0x90,/*9*/          
 251                        };
 252          unsigned char code  p[]="Setting";  
 253          void year(unsigned char k);//Äê¼Ó¼õ
 254          void month(unsigned char k);//ÔÂ¼Ó¼õ
 255          void day(unsigned char k);
 256          void hour(unsigned char k);
 257          void min(unsigned char k);
 258          void sec(unsigned char k);
 259          void weekset(unsigned char k);//ÖÜ¼Ó¼õ
 260          void timesetting();//µç×ÓÖÓÉèÖÃ
 261          void readtime();  //¶ÁÈ¡DS13B20ÖÐµÄÊ±¼ä
 262          
 263          #define  NOP()   _nop_() 
 264          sbit RELAY = P3^0;  
 265          sbit KEY=P3^1;
 266          int num1 =0;
 267          sbit Delay1=P3^2;
 268          sbit bee=P3^3;
 269          void readtime();  //¶ÁÈ¡DS13B20ÖÐµÄÊ±¼ä
 270          unsigned char  timecount=0;
 271          unsigned char T[5];
 272          unsigned char dat;  
 273          unsigned char timedata[]={8,14,50};//Ê±·ÖÃë
 274          unsigned char time1[]={8,15,00};
 275           unsigned char time2[]={21,30,00};
 276          unsigned char i,timenum,u=10;
 277          unsigned char Time0[9];
 278           void delay0(unsigned int n)
 279          {
 280   1        unsigned int k;
 281   1        for(k=2;k>0;k--)
 282   1        {
 283   2          while(n--){NOP();}
 284   2        }
 285   1      }
 286           void delay1(unsigned int n)
 287          {
 288   1        unsigned int k;
 289   1        for(k=1000;k>0;k--)
 290   1        {
 291   2          while(n--);
 292   2        }
 293   1      }
 294          unsigned char keyboardscan(unsigned char n)
 295          {
 296   1        unsigned char board_h, board_l;
 297   1        P1=0x0f;
 298   1        board_h=P1&0x0f;
 299   1        if(board_h!=0x0f)
C51 COMPILER V9.52.0.0   MAIN                                                              05/17/2015 12:17:18 PAGE 6   

 300   1        {
 301   2          delay0(n);
 302   2          board_h=P1&0x0f;
 303   2          if(board_h!=0x0f)
 304   2          {
 305   3            P1=board_h|0xf0;
 306   3            board_l=P1&0xf0;
 307   3            bee=1;
 308   3            delay0(n);
 309   3            bee=0;
 310   3            return(board_h+board_l);
 311   3          }
 312   2        }
 313   1        return(0xff);
 314   1      }
 315          
 316          void clockdisaplay();
 317          void delayA(unsigned int n);
 318          void clocksetting();
 319          void conctrlRelay();
 320          void KEY_Detect();
 321          unsigned char hc74_165();
 322          //void Delay(unsigned int n); //ÑÓÊ±º¯Êý
 323          void delay1msA();
 324          
 325          void daydata()   //ÉèÖÃÌìÊýº¯Êý
 326          {
 327   1        unsigned char day;
 328   1        switch(Time0[4])
 329   1        {
 330   2          case 0x01: day=0x31;break;
 331   2          case 0x03: day=0x31;break;
 332   2          case 0x04: day=0x30;break;
 333   2          case 0x05: day=0x31;break;
 334   2          case 0x06: day=0x30;break;
 335   2          case 0x07: day=0x31;break;
 336   2          case 0x08: day=0x31;break;
 337   2          case 0x09: day=0x30;break;
 338   2          case 0x10: day=0x31;break;
 339   2          case 0x11: day=0x30;break;
 340   2          case 0x12: day=0x31;break;
 341   2        }
 342   1      }
 343          
 344          unsigned char checkday()                  //×Ô¶¯¼ì²éÊÇ·ñÊÇÈòÄê£¬²¢Îª¶ÔÓ¦µÄÔÂ·ÝÉèÖÃÌìÊý
 345          {
 346   1        unsigned char day;
 347   1        unsigned int year;
 348   1        year=Time0[7]/16*1000+Time0[7]%16*100+Time0[6]/16*10+Time0[6]%16;
 349   1        
 350   1        if(((year%4==0)&&(year%100==0))||(year%400==0))//ÅÐ¶ÏÊÇ·ñÊÇÈòÄê
 351   1       {
 352   2          switch(Time0[4])
 353   2        {
 354   3          case 0x01: day=0x31;break;
 355   3          case 0x02: day=0x29;break;
 356   3          case 0x03: day=0x31;break;
 357   3          case 0x04: day=0x30;break;
 358   3          case 0x05: day=0x31;break;
 359   3          case 0x06: day=0x30;break;
 360   3          case 0x07: day=0x31;break;
 361   3          case 0x08: day=0x31;break;
C51 COMPILER V9.52.0.0   MAIN                                                              05/17/2015 12:17:18 PAGE 7   

 362   3          case 0x09: day=0x30;break;
 363   3          case 0x10: day=0x31;break;
 364   3          case 0x11: day=0x30;break;
 365   3          case 0x12: day=0x31;break;
 366   3        }
 367   2       }
 368   1       else
 369   1       {
 370   2       switch(Time0[4])
 371   2        {
 372   3          case 0x01: day=0x31;break;
 373   3          case 0x02: day=0x28;break;
 374   3          case 0x03: day=0x31;break;
 375   3          case 0x04: day=0x30;break;
 376   3          case 0x05: day=0x31;break;
 377   3          case 0x06: day=0x30;break;
 378   3          case 0x07: day=0x31;break;
 379   3          case 0x08: day=0x31;break;
 380   3          case 0x09: day=0x30;break;
 381   3          case 0x10: day=0x31;break;
 382   3          case 0x11: day=0x30;break;
 383   3          case 0x12: day=0x31;break;
 384   3        }
 385   2        }
 386   1       
 387   1       return(day);
 388   1      }
 389          void main()
 390          {
 391   1        unsigned char code p0[]="DATE:",
 392   1                           p1[]= "TIME:",
 393   1                          
 394   1                           p4[]="Relay:";
 395   1        
 396   1      
 397   1            TMOD=0x01;
 398   1                        TH0=0xd8;TL0=0xf0; //10ms
 399   1                        EA=1;ET0=1;
 400   1                       IT0=0;EX0=1;
 401   1           LCD1602_Init();
 402   1        //LCD1602_DisplayOneCharOnAddr(0,0,'A');
 403   1        //while(1);
 404   1           Time0[7]=0x20;
 405   1           readtime();  
 406   1           
 407   1          
 408   1          // LCD1602_WriteInformation(0x01,0);  //ÇåÆÁÖ¸Áî
 409   1        //LCD1602_MoveToPosition(0,0);
 410   1            //     LCD1602_DisplayString(p0);
 411   1        //while(1);
 412   1        //num1=0;
 413   1        
 414   1           while(1)
 415   1         {
 416   2             
 417   2              
 418   2             switch(num1)
 419   2             {
 420   3               case 0:
 421   3               {  
 422   4                 LCD1602_MoveToPosition(0,0);
 423   4                 LCD1602_DisplayString(p0);
C51 COMPILER V9.52.0.0   MAIN                                                              05/17/2015 12:17:18 PAGE 8   

 424   4                 LcdDisplay();
 425   4                 timesetting();
 426   4                 //break;
 427   4               }
 428   3               case 1:
 429   3               {
 430   4                 LcdDisplayTemp0(Ds18b20ReadTemp());//ÏÔÊ¾ÎÂ¶È
 431   4                 pcf8591Play();
 432   4                 //break;
 433   4                }
 434   3             }
 435   2             switch(keyboardscan(1))
 436   2             {
 437   3             case 0xbd:
 438   3                  // LCD1602_WriteInformation(0x01,0);
 439   3                  num1=0;break;
 440   3                case 0xbe:
 441   3                    //LCD1602_WriteInformation(0x01,0);
 442   3                  num1=1;break;
 443   3             }
 444   2      }
 445   1      }
*** WARNING C280 IN LINE 392 OF main.c: 'p1': unreferenced local variable
*** WARNING C280 IN LINE 394 OF main.c: 'p4': unreferenced local variable
 446          
 447          void LcdDisplay()
 448          {  
 449   1        readtime();
 450   1            if((Time0[7]&0x0a)==0x0a)    
 451   1            {   
 452   2                Time0[7]=(Time0[7]&0xf0);
 453   2                Time0[7]+=0x10;
 454   2            }
 455   1            if((Time0[7]&0x0f)==0x0f)
 456   1            {   
 457   2                Time0[7]=(Time0[7]&0xf0);
 458   2                Time0[7]+=0x09;
 459   2            }
 460   1            LCD1602_DisplayOneCharOnAddr(0,5,'0'+Time0[7]/16);
 461   1            LCD1602_DisplayOneCharOnAddr(0,6,'0'+Time0[7]%16);
 462   1            LCD1602_DisplayOneCharOnAddr(0,7,('0'+Time0[6]/16));      //Äê
 463   1            LCD1602_DisplayOneCharOnAddr(0,8,('0'+Time0[6]%16));
 464   1            LCD1602_DisplayOneCharOnAddr(0,9,(0x00));
 465   1            LCD1602_DisplayOneCharOnAddr(0,10,('0'+Time0[4]/16));     //ÔÂ
 466   1            LCD1602_DisplayOneCharOnAddr(0,11,('0'+Time0[4]%16));
 467   1            LCD1602_DisplayOneCharOnAddr(0,12,(0x01));
 468   1            LCD1602_DisplayOneCharOnAddr(0,13,('0'+Time0[3]/16));     //ÈÕ
 469   1            LCD1602_DisplayOneCharOnAddr(0,14,('0'+Time0[3]%16)); 
 470   1            LCD1602_DisplayOneCharOnAddr(0,15,0x02);
 471   1            LCD1602_MoveToPosition(1,0);
 472   1            LCD1602_DisplayString(p1);
 473   1            LCD1602_DisplayOneCharOnAddr(1,8,('0'+Time0[2]/16));        //Ê±
 474   1            LCD1602_DisplayOneCharOnAddr(1,9,('0'+Time0[2]%16));         
 475   1            LCD1602_DisplayOneCharOnAddr(1,10,(':'));
 476   1            LCD1602_DisplayOneCharOnAddr(1,11,('0'+Time0[1]/16));       //·Ö
 477   1            LCD1602_DisplayOneCharOnAddr(1,12,('0'+Time0[1]%16)); 
 478   1            LCD1602_DisplayOneCharOnAddr(1,13,(':'));
 479   1            LCD1602_DisplayOneCharOnAddr(1,14,('0'+Time0[0]/16));       //Ãë
 480   1            LCD1602_DisplayOneCharOnAddr(1,15,('0'+Time0[0]%16));
 481   1            
 482   1            
 483   1      }
C51 COMPILER V9.52.0.0   MAIN                                                              05/17/2015 12:17:18 PAGE 9   

 484           
 485          /*unsigned char checkday()                  //×Ô¶¯¼ì²éÊÇ·ñÊÇÈòÄê£¬²¢Îª¶ÔÓ¦µÄÔÂ·ÝÉèÖÃÌìÊý
 486          {
 487            unsigned char day;
 488            unsigned int year;
 489            year=Time0[7]/16*1000+Time0[7]%16*100+Time0[6]/16*10+Time0[6]%16;
 490            
 491            if(((year%4==0)&&(year%100==0))||(year%400==0))//ÅÐ¶ÏÊÇ·ñÊÇÈòÄê
 492           {
 493              switch(Time0[4])
 494            {
 495              case 0x01: day=0x31;break;
 496              case 0x02: day=0x29;break;
 497              case 0x03: day=0x31;break;
 498              case 0x04: day=0x30;break;
 499              case 0x05: day=0x31;break;
 500              case 0x06: day=0x30;break;
 501              case 0x07: day=0x31;break;
 502              case 0x08: day=0x31;break;
 503              case 0x09: day=0x30;break;
 504              case 0x10: day=0x31;break;
 505              case 0x11: day=0x30;break;
 506              case 0x12: day=0x31;break;
 507            }
 508           }
 509           else
 510           {
 511           switch(Time0[4])
 512            {
 513              case 0x01: day=0x31;break;
 514              case 0x02: day=0x28;break;
 515              case 0x03: day=0x31;break;
 516              case 0x04: day=0x30;break;
 517              case 0x05: day=0x31;break;
 518              case 0x06: day=0x30;break;
 519              case 0x07: day=0x31;break;
 520              case 0x08: day=0x31;break;
 521              case 0x09: day=0x30;break;
 522              case 0x10: day=0x31;break;
 523              case 0x11: day=0x30;break;
 524              case 0x12: day=0x31;break;
 525            }
 526            }
 527           
 528           return(day);
 529          }
 530           */
 531          
 532          void timesetting()
 533          {  
 534   1        //LcdDisplay();
 535   1        //LCD1602_MoveToPosition(1,9);
 536   1        //LCD1602_DisplayString(p);
 537   1        switch(keyboardscan(1))
 538   1        {
 539   2            case 0x77:     //°´ÏÂ°´¼ü1£¬½øÈëµ÷ÊÔÄê
 540   2            {
 541   3               LCD1602_MoveToPosition(0,9);
 542   3               LCD1602_WriteInformation(0x0f,0);
 543   3               while (1)
 544   3               {
 545   4                  switch(keyboardscan(1))
C51 COMPILER V9.52.0.0   MAIN                                                              05/17/2015 12:17:18 PAGE 10  

 546   4                  {
 547   5                    case 0x7d://°´ÏÂK9£¬½øÈë¼Ó1
 548   5                     { year(0);break;}
 549   5                    case 0x7e:
 550   5                      {year(1);break;}
 551   5                  }
 552   4                 if(keyboardscan(1)==0xed)
 553   4                 {break;}
 554   4               }
 555   3            }
 556   2            case 0xb7://°´ÏÂK2 ½øÈëµ÷ÊÔÔÂ
 557   2            {
 558   3                LCD1602_MoveToPosition(0,12);
 559   3                 LCD1602_WriteInformation(0x0f,0);
 560   3                while (1)
 561   3                {
 562   4                  switch(keyboardscan(100))
 563   4                  {
 564   5                    case 0x7d://°´ÏÂK9£¬½øÈë¼Ó1
 565   5                        {   month(0);break; }
 566   5                    case 0x7e:
 567   5                       {month(1);break;}
 568   5                  }
 569   4                 if(keyboardscan(1)==0xed)
 570   4                 {break;}
 571   4               }
 572   3            }
 573   2            case 0xd7://°´ÏÂK3 ½øÈëµ÷ÊÔday
 574   2            {
 575   3                LCD1602_MoveToPosition(0,15);
 576   3                 LCD1602_WriteInformation(0x0f,0);
 577   3                while (1)
 578   3                {
 579   4                  switch(keyboardscan(1))
 580   4                  {
 581   5                     case 0x7d://°´ÏÂK9£¬½øÈë¼Ó1
 582   5                        {  day(0);break;  }
 583   5                     case 0x7e://K13
 584   5                        {day(1);break;}
 585   5                  }
 586   4                 if(keyboardscan(1)==0xed)
 587   4                 {break;}
 588   4               }
 589   3            }
 590   2            case 0xe7://°´ÏÂK4 ½øÈëµ÷ÊÔhour
 591   2            {
 592   3                LCD1602_MoveToPosition(1,9);
 593   3                 LCD1602_WriteInformation(0x0f,0);
 594   3                while (1)
 595   3                {
 596   4                  switch(keyboardscan(1))
 597   4                  {
 598   5                      case 0x7d://°´ÏÂK9£¬½øÈë¼Ó1
 599   5                          {  hour(0);break;}
 600   5                      case 0x7e:
 601   5                         {hour(1);break;}
 602   5                  }
 603   4                 if(keyboardscan(1)==0xed)
 604   4                 {break;}
 605   4               }
 606   3            }
 607   2            case 0x7b://°´ÏÂK5 ½øÈëµ÷ÊÔmin
C51 COMPILER V9.52.0.0   MAIN                                                              05/17/2015 12:17:18 PAGE 11  

 608   2            {
 609   3                LCD1602_MoveToPosition(1,12);
 610   3                 LCD1602_WriteInformation(0x0f,0);
 611   3                while (1)
 612   3                {
 613   4                  switch(keyboardscan(1))
 614   4                  {
 615   5                      case 0x7d://°´ÏÂK9£¬½øÈë¼Ó1
 616   5                         {  min(0);break; }
 617   5                      case 0x7e:
 618   5                         {min(1);break;}
 619   5                  }
 620   4                 if(keyboardscan(1)==0xed)
 621   4                 {break;}
 622   4               }
 623   3            }
 624   2            case 0xbb://°´ÏÂK6 ½øÈëµ÷sec
 625   2            {
 626   3                LCD1602_MoveToPosition(1,15);
 627   3                 LCD1602_WriteInformation(0x0f,0);
 628   3                while (1)
 629   3                {
 630   4                  switch(keyboardscan(1))
 631   4                  {
 632   5                       case 0x7d://°´ÏÂK9£¬½øÈë¼Ó1
 633   5                         { sec(0);break;  }
 634   5                       case 0x7e:
 635   5                         {sec(1);break;}
 636   5                  }
 637   4                 if(keyboardscan(1)==0xed)
 638   4                 {break;}
 639   4               }
 640   3            }
 641   2             
 642   2         }
 643   1      }
 644          
 645          
 646          void LcdDisplayTemp0(int temp)   //lcdÏÔÊ¾
 647          {
 648   1        unsigned char i; 
 649   1        unsigned char code  p2[]= "TEMP:";
 650   1          float tp;  
 651   1        if(temp< 0)       //µ±ÎÂ¶ÈÖµÎª¸ºÊý
 652   1          {
 653   2          DisplayData[0] = 0x40; 
 654   2          //ÒòÎª¶ÁÈ¡µÄÎÂ¶ÈÊÇÊµ¼ÊÎÂ¶ÈµÄ²¹Âë£¬ËùÒÔ¼õ1£¬ÔÙÈ¡·´Çó³öÔ­Âë
 655   2          temp=temp-1;
 656   2          temp=~temp;
 657   2          tp=temp;
 658   2          temp=tp*0.0625*100+0.5; 
 659   2          //ÁôÁ½¸öÐ¡Êýµã¾Í*100£¬+0.5ÊÇËÄÉáÎåÈë£¬ÒòÎªCÓïÑÔ¸¡µãÊý×ª»»ÎªÕûÐÍµÄÊ±ºò°ÑÐ¡Êýµã
 660   2          //ºóÃæµÄÊý×Ô¶¯È¥µô£¬²»¹ÜÊÇ·ñ´óÓÚ0.5£¬¶ø+0.5Ö®ºó´óÓÚ0.5µÄ¾ÍÊÇ½ø1ÁË£¬Ð¡ÓÚ0.5µÄ¾Í
 661   2          //ËãÓÉÏ0.5£¬»¹ÊÇÔÚÐ¡ÊýµãºóÃæ¡£
 662   2       
 663   2          }
 664   1        else
 665   1          {     
 666   2          DisplayData[0] = 0x00;
 667   2          tp=temp;//ÒòÎªÊý¾Ý´¦ÀíÓÐÐ¡ÊýµãËùÒÔ½«ÎÂ¶È¸³¸øÒ»¸ö¸¡µãÐÍ±äÁ¿
 668   2          //Èç¹ûÎÂ¶ÈÊÇÕýµÄÄÇÃ´£¬ÄÇÃ´ÕýÊýµÄÔ­Âë¾ÍÊÇ²¹ÂëËü±¾Éí
 669   2          temp=tp*0.0625*100+0.5; 
C51 COMPILER V9.52.0.0   MAIN                                                              05/17/2015 12:17:18 PAGE 12  

 670   2          //ÁôÁ½¸öÐ¡Êýµã¾Í*100£¬+0.5ÊÇËÄÉáÎåÈë£¬ÒòÎªCÓïÑÔ¸¡µãÊý×ª»»ÎªÕûÐÍµÄÊ±ºò°ÑÐ¡Êýµã
 671   2          //ºóÃæµÄÊý×Ô¶¯È¥µô£¬²»¹ÜÊÇ·ñ´óÓÚ0.5£¬¶ø+0.5Ö®ºó´óÓÚ0.5µÄ¾ÍÊÇ½ø1ÁË£¬Ð¡ÓÚ0.5µÄ¾Í
 672   2          //Ëã¼ÓÉÏ0.5£¬»¹ÊÇÔÚÐ¡ÊýµãºóÃæ¡£
 673   2        }
 674   1        //P3=tp;
 675   1      
 676   1        Data0[0] = temp / 10000;
 677   1        Data0[1] = temp % 10000 / 1000;
 678   1        Data0[2] = temp % 1000 / 100 ;
 679   1        Data0[3] = temp % 100 / 10;
 680   1        Data0[4] = temp % 10;
 681   1        
 682   1        for(i=0;i<=4;i++)
 683   1        {
 684   2          switch(Seg_Data[Data0[i]])
 685   2          {
 686   3            case 0xc0:
 687   3            {T[i]=0x30;break;}
 688   3            case 0xF9:
 689   3            {T[i]=0x31;break;}
 690   3            case 0xA4:
 691   3            {T[i]=0x32;break;}
 692   3            case 0xB0:
 693   3            {T[i]=0x33;break;}
 694   3            case 0x99:
 695   3            {T[i]=0x34;break;}
 696   3            case 0x92:
 697   3            { T[i]=0x35;break;}
 698   3            case 0x82:
 699   3            { T[i]=0x30;break;}
 700   3            case 0xF8:
 701   3            {T[i]=0x36;break;}
 702   3            case 0x80:
 703   3            {T[i]=0x37;break;}
 704   3            case 0x90:
 705   3            {T[i]=0x38;break;}      
 706   3          }
 707   2        }
 708   1             LCD1602_WriteInformation(0x01,0);  //ÇåÆÁÖ¸Áî
 709   1        LCD1602_MoveToPosition(0,0);
 710   1                 LCD1602_DisplayString(p2);
 711   1             LCD1602_DisplayOneCharOnAddr(0,6,T[1]);
 712   1            LCD1602_DisplayOneCharOnAddr(0,7,T[2]);
 713   1            LCD1602_DisplayOneCharOnAddr(0,8,0x2e);//.
 714   1            LCD1602_DisplayOneCharOnAddr(0,9,T[3]);
 715   1             LCD1602_DisplayOneCharOnAddr(0,10,0x06); //¡ãc
 716   1      }
 717           
 718           void delayA(unsigned int n)
 719          {
 720   1        unsigned int t;
 721   1        for(t=5;t>0;t--)
 722   1        {
 723   2           while(n--){ NOP();}
 724   2        }
 725   1      }
 726          
 727          
 728          
 729          void year(unsigned char k)
 730          {
 731   1        if(k==0)                //¼ÓÒ»
C51 COMPILER V9.52.0.0   MAIN                                                              05/17/2015 12:17:18 PAGE 13  

 732   1        { 
 733   2          Time0[6]+=0x01;
 734   2          if(Time0[6]==0x9a)
 735   2          {
 736   3              Time0[6]=0x00;
 737   3              Time0[7]+=0x01;
 738   3              if((Time0[7]&0x0a)==0x0a)
 739   3              {   
 740   4                  Time0[7]=(Time0[7]&0xf0);
 741   4                  Time0[7]+=0x10;
 742   4              }
 743   3          }
 744   2          if((Time0[6]&0x0a)==0x0a)
 745   2          {   
 746   3              Time0[6]=(Time0[6]&0xf0);
 747   3              Time0[6]+=0x10;
 748   3           }  
 749   2        }
 750   1        if(k==1)                 //¼õÒ»
 751   1        {
 752   2           Time0[6]-=0x01;
 753   2           if((Time0[6]&0x0f)==0x0f)
 754   2            {   
 755   3                Time0[6]=(Time0[6]&0xf0);
 756   3                Time0[6]+=0x09;
 757   3            }
 758   2            if(Time0[6]==0x00)
 759   2            {   
 760   3                Time0[6]=0x99;
 761   3                Time0[7]-=0x01;
 762   3                if((Time0[7]&0x0f)==0x0f)
 763   3                {   
 764   4                     Time0[7]=(Time0[7]&0xf0);
 765   4                     Time0[7]+=0x09;
 766   4                }
 767   3            } 
 768   2        }
 769   1        DS1302_WriteOneByteAtAddr(0x8e,0x00);               
 770   1        DS1302_SetInit(Time0);                 //¶ÔÊ±ÖÓ½øÐÐÉèÖÃ
 771   1        DS1302_WriteOneByteAtAddr(0x8e,0x80);
 772   1         LcdDisplay();
 773   1        LCD1602_MoveToPosition(0,9);           //ÔÚÄêµÄÊý×ÖÉÏÉÁË¸
 774   1        LCD1602_WriteInformation(0x0f,0); 
 775   1      }
 776          
 777          void month(unsigned char k)
 778          {
 779   1        if(k==0)
 780   1        {
 781   2          Time0[4]+=0x01;
 782   2          if(Time0[4]==0x13)
 783   2          {
 784   3              Time0[4]=0x01;
 785   3          }
 786   2          if((Time0[4]&0x0a)==0x0a)
 787   2          {   
 788   3            Time0[4]=(Time0[4]&0xf0);
 789   3            Time0[4]+=0x10;
 790   3          }
 791   2         }
 792   1        if(k==1)
 793   1        {
C51 COMPILER V9.52.0.0   MAIN                                                              05/17/2015 12:17:18 PAGE 14  

 794   2          Time0[4]-=0x01;
 795   2          if(Time0[4]==0x00)
 796   2          {   
 797   3              Time0[4]=0x12;
 798   3          } 
 799   2         if((Time0[4]&0x0f)==0x0f)
 800   2          {   
 801   3              Time0[4]=(Time0[4]&0xf0);
 802   3              Time0[4]+=0x09;
 803   3          }
 804   2        }
 805   1        DS1302_WriteOneByteAtAddr(0x8e,0x00); 
 806   1        DS1302_SetInit(Time0);
 807   1        DS1302_WriteOneByteAtAddr(0x8e,0x80);
 808   1        LcdDisplay();
 809   1         LCD1602_MoveToPosition(0,12);
 810   1         LCD1602_WriteInformation(0x0f,0);
 811   1      }
 812          
 813          void day(unsigned char k)
 814          {
 815   1         if(k==0)
 816   1         {        
 817   2           if(Time0[3]==checkday())
 818   2           {    
 819   3              Time0[3]=0x00;
 820   3           }  
 821   2          Time0[3]+=0x01;
 822   2          if((Time0[3]&0x0a)==0x0a)
 823   2          {   
 824   3              Time0[3]=(Time0[3]&0xf0);
 825   3              Time0[3]+=0x10;
 826   3              DS1302_SetInit(Time0);
 827   3          }
 828   2        }
 829   1        if(k==1)
 830   1        {
 831   2           if(Time0[3]==0x01)
 832   2            {   
 833   3                Time0[3]=checkday()+0x01;
 834   3            } 
 835   2            Time0[3]-=0x01;
 836   2            if((Time0[3]&0x0f)==0x0f)
 837   2            {   
 838   3                Time0[3]=(Time0[3]&0xf0);
 839   3                Time0[3]+=0x09;
 840   3            }
 841   2        }
 842   1        DS1302_WriteOneByteAtAddr(0x8e,0x00); 
 843   1        DS1302_SetInit(Time0);
 844   1        DS1302_WriteOneByteAtAddr(0x8e,0x80);
 845   1        LcdDisplay();
 846   1        LCD1602_MoveToPosition(0,15);
 847   1        LCD1602_WriteInformation(0x0f,0);
 848   1      }
 849          void hour(unsigned char k)
 850          {
 851   1         if(k==0)
 852   1         {
 853   2           Time0[2]+=0x01;
 854   2           if(Time0[2]==0x24)
 855   2           {
C51 COMPILER V9.52.0.0   MAIN                                                              05/17/2015 12:17:18 PAGE 15  

 856   3              Time0[2]=0x00;
 857   3           }
 858   2          if((Time0[2]&0x0a)==0x0a)
 859   2          {   
 860   3              Time0[2]=(Time0[2]&0xf0);
 861   3              Time0[2]+=0x10;
 862   3           }
 863   2         }
 864   1         if(k==1) 
 865   1          {
 866   2            if(Time0[2]==0x00)
 867   2            {   
 868   3                Time0[2]=0x24;
 869   3            } 
 870   2            Time0[2]-=0x01;
 871   2            if((Time0[2]&0x0f)==0x0f)
 872   2            {   
 873   3                Time0[2]=(Time0[2]&0xf0);
 874   3                Time0[2]+=0x09;
 875   3            } 
 876   2          }       
 877   1          DS1302_WriteOneByteAtAddr(0x8e,0x00); 
 878   1          DS1302_SetInit(Time0);
 879   1          DS1302_WriteOneByteAtAddr(0x8e,0x80);
 880   1          LcdDisplay();
 881   1          LCD1602_MoveToPosition(1,9);
 882   1          LCD1602_WriteInformation(0x0f,0);
 883   1      }
 884          
 885          void min(unsigned char k)
 886          {
 887   1        if(k==0)
 888   1        {
 889   2          Time0[1]+=0x01;
 890   2          if((Time0[1]&0x0a)==0x0a)
 891   2          {   
 892   3             Time0[1]=(Time0[1]&0xf0);
 893   3             Time0[1]+=0x10;
 894   3          }
 895   2          if(Time0[1]==0x60)
 896   2          {
 897   3              Time0[1]=0x00;
 898   3          }
 899   2        }
 900   1        if(k==1)
 901   1        {
 902   2          if(Time0[1]==0x00)
 903   2          {   
 904   3              Time0[1]=0x60;
 905   3          }
 906   2          Time0[1]-=0x01;
 907   2          if((Time0[1]&0x0f)==0x0f)
 908   2          {   
 909   3              Time0[1]=(Time0[1]&0xf0);
 910   3              Time0[1]+=0x09;
 911   3          } 
 912   2        }
 913   1        DS1302_WriteOneByteAtAddr(0x8e,0x00); 
 914   1        DS1302_SetInit(Time0);
 915   1        DS1302_WriteOneByteAtAddr(0x8e,0x80);
 916   1        LcdDisplay();
 917   1        LCD1602_MoveToPosition(1,12);
C51 COMPILER V9.52.0.0   MAIN                                                              05/17/2015 12:17:18 PAGE 16  

 918   1        LCD1602_WriteInformation(0x0f,0);
 919   1      }
 920          void sec(unsigned char k)
 921          {
 922   1        if(k==0)
 923   1        {
 924   2          Time0[0]+=0x01;
 925   2          if((Time0[0]&0x0a)==0x0a)
 926   2          {   
 927   3             Time0[0]=(Time0[0]&0xf0);
 928   3            Time0[0]+=0x10;
 929   3          }
 930   2          if(Time0[0]==0x60)
 931   2          {
 932   3                Time0[0]=0x00;
 933   3          }
 934   2        }
 935   1        if(k==1)
 936   1        {
 937   2          if(Time0[0]==0x00)
 938   2          {   
 939   3              Time0[0]=0x60;
 940   3          } 
 941   2          Time0[0]-=0x01;
 942   2          if((Time0[0]&0x0f)==0x0f)
 943   2          {   
 944   3                Time0[0]=(Time0[0]&0xf0);
 945   3                Time0[0]+=0x09;
 946   3          } 
 947   2        }
 948   1        DS1302_WriteOneByteAtAddr(0x8e,0x00); 
 949   1        DS1302_SetInit(Time0);
 950   1        DS1302_WriteOneByteAtAddr(0x8e,0x80);
 951   1        LcdDisplay();
 952   1        LCD1602_MoveToPosition(1,15);
 953   1        LCD1602_WriteInformation(0x0f,0);
 954   1      }
 955          
 956          
 957          
 958          
 959          
 960          
 961          
 962          
 963          /*******************************************************************************
 964          * º¯ Êý Ãû         : Pcf8591SendByte
 965          * º¯Êý¹¦ÄÜ       : Ð´ÈëÒ»¸ö¿ØÖÆÃüÁî
 966          * Êä    Èë         : channel£¨×ª»»Í¨µÀ£©
 967          * Êä    ³ö         : ÎÞ
 968          *******************************************************************************/
 969          
 970          void Pcf8591SendByte(unsigned char channel)
 971          { 
 972   1        I2C_Start();
 973   1        I2C_SendByte(WRITEADDR, 1);    //·¢ËÍÐ´Æ÷¼þµØÖ·
 974   1        I2C_SendByte(0x40|channel, 0); //·¢ËÍ¿ØÖÆ¼Ä´æÆ÷
 975   1        I2C_Stop();
 976   1      }
 977          /*******************************************************************************
 978          * º¯ Êý Ãû         : Pcf8591ReadByte
 979          * º¯Êý¹¦ÄÜ       : ¶ÁÈ¡Ò»¸ö×ª»»Öµ
C51 COMPILER V9.52.0.0   MAIN                                                              05/17/2015 12:17:18 PAGE 17  

 980          * Êä    Èë         : ÎÞ
 981          * Êä    ³ö         : dat
 982          *******************************************************************************/
 983          
 984          unsigned char Pcf8591ReadByte()
 985          {
 986   1        unsigned char dat;
 987   1        I2C_Start();
 988   1        I2C_SendByte(READADDR, 1);//·¢ËÍ¶ÁÆ÷¼þµØÖ·
 989   1        dat=I2C_ReadByte();    //¶ÁÈ¡Êý¾Ý
 990   1        I2C_Stop();            //½áÊø×ÜÏß
 991   1          return dat;
 992   1      }
 993          /*******************************************************************************
 994          * º¯ Êý Ãû         : Pcf8591DaConversion
 995          * º¯Êý¹¦ÄÜ       : PCF8591µÄÊä³ö¶ËÊä³öÄ£ÄâÁ¿
 996          * Êä    Èë         : value£¨×ª»»µÄÊýÖµ£©
 997          * Êä    ³ö         : ÎÞ
 998          *******************************************************************************/
 999          
1000          void Pcf8591DaConversion(unsigned char value)
1001          {
1002   1        I2C_Start();
1003   1      
1004   1        I2C_SendByte(WRITEADDR, 1);//·¢ËÍÐ´Æ÷¼þµØÖ·
1005   1        I2C_SendByte(0x40, 1);     //¿ªÆôDAÐ´µ½¿ØÖÆ¼Ä´æÆ÷
1006   1        I2C_SendByte(value, 0);    //·¢ËÍ×ª»»ÊýÖµ
1007   1        I2C_Stop(); 
1008   1      }
1009          
1010          void pcf8591Play()
1011          {unsigned char i,AD[5];
1012   1          unsigned int adNum;
1013   1        unsigned char code  p3[]="AD1:";
1014   1        float value;
1015   1          //--ÏÔÊ¾µçÎ»Æ÷µçÑ¹--//
1016   1          Pcf8591SendByte(0);             //·¢ËÍµçÎ»Æ÷×ª»»ÃüÁî
1017   1      
1018   1          adNum = Pcf8591ReadByte()*2;//½«×ª»»½á¹û¶Á×ß
1019   1      
1020   1          //--ÎÒÃÇ8591Ã¿¶ÁÈ¡µ½Ò»¸ö1¾Í±íÊ¾5/256V£¬ËùÒÔÒªÖªµÀµçÑ¹Öµ¾Í³ËÒÔ0.01953--//
1021   1          value = adNum / 2 * 0.01953;  //×ªÎªµçÑ¹Öµ
1022   1          adNum = value * 100;        //±£ÁôÁ½Î»Ð¡Êý
1023   1        LCD1602_MoveToPosition(1,0);
1024   1                 LCD1602_DisplayString(p3);
1025   1        ADData[0] = adNum/ 10000;
1026   1        ADData[1] = adNum % 10000 / 1000;
1027   1        ADData[2] = adNum % 1000 / 100 ;
1028   1        ADData[3] = adNum % 100/10;
1029   1        ADData[4] = adNum % 10;
1030   1          for(i=0;i<=4;i++)
1031   1        {
1032   2          switch(Seg_Data[ADData[i]])
1033   2          {
1034   3            case 0xc0:
1035   3            {AD[i]=0x30;break;}
1036   3            case 0xF9:
1037   3            {AD[i]=0x31;break;}
1038   3            case 0xA4:
1039   3            {AD[i]=0x32;break;}
1040   3            case 0xB0:
1041   3            {AD[i]=0x33;break;}
C51 COMPILER V9.52.0.0   MAIN                                                              05/17/2015 12:17:18 PAGE 18  

1042   3            case 0x99:
1043   3            {AD[i]=0x34;break;}
1044   3            case 0x92:
1045   3            { AD[i]=0x35;break;}
1046   3            case 0x82:
1047   3            { AD[i]=0x30;break;}
1048   3            case 0xF8:
1049   3            {AD[i]=0x36;break;}
1050   3            case 0x80:
1051   3            {AD[i]=0x37;break;}
1052   3            case 0x90:
1053   3            {AD[i]=0x38;break;}     
1054   3          }
1055   2        }
1056   1         LCD1602_DisplayOneCharOnAddr(1,6,AD[2]);
1057   1            LCD1602_DisplayOneCharOnAddr(1,8,AD[3]);
1058   1            LCD1602_DisplayOneCharOnAddr(1,7,0x2e);//.
1059   1            LCD1602_DisplayOneCharOnAddr(1,9,AD[4]);
1060   1        LCD1602_DisplayOneCharOnAddr(1,10,'V');
1061   1            Pcf8591DaConversion(adNum/2); //DAC   ÊýÄ£×ª»»
1062   1          
1063   1      }
1064          
1065          void RestTime()
1066          {
1067   1        unsigned char timenum;
1068   1        if((Time0[2]/16)==0)
1069   1        {
1070   2          if((Time0[2]%16)==8)
1071   2          {  if(Time0[1]/16==0)
1072   3                 { if(Time0[1]==0)
1073   4                    {
1074   5                        RELAY=0;
1075   5                        
1076   5                       timenum=0;   
1077   5                       timecount=0;
1078   5                       TR0=1;
1079   5                        if(timecount==20)
1080   5                        {
1081   6                            RELAY=1;timecount=0;
1082   6                        }
1083   5                      }
1084   4                    }
1085   3          }
1086   2        }
1087   1          if((Time0[2]/16)==0)
1088   1        {
1089   2          if((Time0[2]%16)==8)
1090   2          {  if(Time0[1]/16==5)
1091   3                 { if(Time0[1]==0)
1092   4                    {
1093   5                        RELAY=1;
1094   5                        
1095   5                       timenum=0;   
1096   5                       timecount=0;
1097   5                       TR0=1;
1098   5                        if(timecount==20)
1099   5                        {
1100   6                            RELAY=1;timecount=0;
1101   6                        }
1102   5                      }
1103   4                    }
C51 COMPILER V9.52.0.0   MAIN                                                              05/17/2015 12:17:18 PAGE 19  

1104   3          }
1105   2        }
1106   1          if((Time0[2]/16)==0)
1107   1        {
1108   2          if((Time0[2]%16)==9)
1109   2          {  if(Time0[1]/16==0)
1110   3                 { if(Time0[1]==0)
1111   4                    {
1112   5                        RELAY=0;
1113   5                        
1114   5                       timenum=0;   
1115   5                       timecount=0;
1116   5                       TR0=1;
1117   5                        if(timecount==20)
1118   5                        {
1119   6                            RELAY=1;timecount=0;
1120   6                        }
1121   5                      }
1122   4                    }
1123   3          }
1124   2        }
1125   1          if((Time0[2]/16)==0)
1126   1        {
1127   2          if((Time0[2]%16)==9)
1128   2          {  if(Time0[1]/16==5)
1129   3                 { if(Time0[1]==0)
1130   4                    {
1131   5                        RELAY=1;
1132   5                        
1133   5                       timenum=0;   
1134   5                       timecount=0;
1135   5                       TR0=1;
1136   5                        if(timecount==20)
1137   5                        {
1138   6                            RELAY=1;timecount=0;
1139   6                        }
1140   5                      }
1141   4                    }
1142   3          }
1143   2        }
1144   1          if((Time0[2]/16)==1)
1145   1        {
1146   2          if((Time0[2]%16)==0)
1147   2          {  if(Time0[1]/16==1)
1148   3                 { if(Time0[1]==0)
1149   4                    {
1150   5                        RELAY=0;
1151   5                        
1152   5                       timenum=0;   
1153   5                       timecount=0;
1154   5                       TR0=1;
1155   5                        if(timecount==20)
1156   5                        {
1157   6                            RELAY=1;timecount=0;
1158   6                        }
1159   5                      }
1160   4                    }
1161   3          }
1162   2        }
1163   1          if((Time0[2]/16)==1)
1164   1        {
1165   2          if((Time0[2]%16)==1)
C51 COMPILER V9.52.0.0   MAIN                                                              05/17/2015 12:17:18 PAGE 20  

1166   2          {  if(Time0[1]/16==0)
1167   3                 { if(Time0[1]==0)
1168   4                    {
1169   5                        RELAY=1;
1170   5                        
1171   5                       timenum=0;   
1172   5                       timecount=0;
1173   5                       TR0=1;
1174   5                        if(timecount==20)
1175   5                        {
1176   6                            RELAY=1;timecount=0;
1177   6                        }
1178   5                      }
1179   4                    }
1180   3          }
1181   2        }
1182   1          if((Time0[2]/16)==1)
1183   1        {
1184   2          if((Time0[2]%16)==1)
1185   2          {  if(Time0[1]/16==1)
1186   3                 { if(Time0[1]==0)
1187   4                    {
1188   5                        RELAY=0;
1189   5                        
1190   5                       timenum=0;   
1191   5                       timecount=0;
1192   5                       TR0=1;
1193   5                        if(timecount==20)
1194   5                        {
1195   6                            RELAY=1;timecount=0;
1196   6                        }
1197   5                      }
1198   4                    }
1199   3          }
1200   2        }
1201   1          if((Time0[2]/16)==1)
1202   1        {
1203   2          if((Time0[2]%16)==2)
1204   2          {  if(Time0[1]/16==0)
1205   3                 { if(Time0[1]==0)
1206   4                    {
1207   5                        RELAY=1;
1208   5                        
1209   5                       timenum=0;   
1210   5                       timecount=0;
1211   5                       TR0=1;
1212   5                        if(timecount==20)
1213   5                        {
1214   6                            RELAY=1;timecount=0;
1215   6                        }
1216   5                      }
1217   4                    }
1218   3          }
1219   2        }
1220   1        
1221   1      }
1222          
1223          
1224          
1225          void time() interrupt 1     //????,
1226          {
1227   1        TH0=0xd8;TL0=0xf0;
C51 COMPILER V9.52.0.0   MAIN                                                              05/17/2015 12:17:18 PAGE 21  

1228   1        timenum++;
1229   1        if(timenum==100)
1230   1        { timenum=0;
1231   2          timecount++; 
1232   2        }
1233   1      }
1234          
1235          void readtime()
1236          {
1237   1           Time0[0]= (DS1302_ReadOneByteAtAddr(ADDR_SEC_R));
1238   1           Time0[1]= (DS1302_ReadOneByteAtAddr(ADDR_MIN_R));
1239   1           Time0[2]= (DS1302_ReadOneByteAtAddr(ADDR_HOUR_R));
1240   1           Time0[3]= (DS1302_ReadOneByteAtAddr(ADDR_DAY_R));
1241   1           Time0[4]= (DS1302_ReadOneByteAtAddr(ADDR_MONTH_R));
1242   1           Time0[5]= (DS1302_ReadOneByteAtAddr(ADDR_WEEK_R));
1243   1           Time0[6]= (DS1302_ReadOneByteAtAddr(ADDR_YEAR_R));
1244   1      }
1245          
1246          
1247          void Delay1ms(uint y)
1248          {
1249   1        uint x;
1250   1        for( ; y>0; y--)
1251   1        {
1252   2          for(x=110; x>0; x--);
1253   2        }
1254   1      }
1255          /*******************************************************************************
1256          * º¯ Êý Ãû         : Ds18b20Init
1257          * º¯Êý¹¦ÄÜ       : ³õÊ¼»¯
1258          * Êä    Èë         : ÎÞ
1259          * Êä    ³ö         : ³õÊ¼»¯³É¹¦·µ»Ø1£¬Ê§°Ü·µ»Ø0
1260          *******************************************************************************/
1261          
1262          uchar Ds18b20Init()
1263          {
1264   1        uchar i;
1265   1        DSPORT = 0;      //½«×ÜÏßÀ­µÍ480us~960us
1266   1        i = 70; 
1267   1        while(i--);//ÑÓÊ±642us
1268   1        DSPORT = 1;     //È»ºóÀ­¸ß×ÜÏß£¬Èç¹ûDS18B20×ö³ö·´Ó¦»á½«ÔÚ15us~60usºó×ÜÏßÀ­µÍ
1269   1        i = 0;
1270   1        while(DSPORT) //µÈ´ýDS18B20À­µÍ×ÜÏß
1271   1        {
1272   2          Delay1ms(1);
1273   2          i++;
1274   2          if(i>5)//µÈ´ý>5MS
1275   2          {
1276   3            return 0;//³õÊ¼»¯Ê§°Ü
1277   3          }
1278   2        
1279   2        }
1280   1        return 1;//³õÊ¼»¯³É¹¦
1281   1      }
1282          
1283          /*******************************************************************************
1284          * º¯ Êý Ãû         : Ds18b20WriteByte
1285          * º¯Êý¹¦ÄÜ       : Ïò18B20Ð´ÈëÒ»¸ö×Ö½Ú
1286          * Êä    Èë         : com
1287          * Êä    ³ö         : ÎÞ
1288          *******************************************************************************/
1289          
C51 COMPILER V9.52.0.0   MAIN                                                              05/17/2015 12:17:18 PAGE 22  

1290          void Ds18b20WriteByte(uchar dat)
1291          {
1292   1        uint i, j;
1293   1      
1294   1        for(j=0; j<8; j++)
1295   1        {
1296   2          DSPORT = 0;         //Ã¿Ð´ÈëÒ»Î»Êý¾ÝÖ®Ç°ÏÈ°Ñ×ÜÏßÀ­µÍ1us
1297   2          i++;
1298   2          DSPORT = dat & 0x01;  //È»ºóÐ´ÈëÒ»¸öÊý¾Ý£¬´Ó×îµÍÎ»¿ªÊ¼
1299   2          i=6;
1300   2          while(i--); //ÑÓÊ±68us£¬³ÖÐøÊ±¼ä×îÉÙ60us
1301   2          DSPORT = 1; //È»ºóÊÍ·Å×ÜÏß£¬ÖÁÉÙ1us¸ø×ÜÏß»Ö¸´Ê±¼ä²ÅÄÜ½Ó×ÅÐ´ÈëµÚ¶þ¸öÊýÖµ
1302   2          dat >>= 1;
1303   2        }
1304   1      }
1305          /*******************************************************************************
1306          * º¯ Êý Ãû         : Ds18b20ReadByte
1307          * º¯Êý¹¦ÄÜ       : ¶ÁÈ¡Ò»¸ö×Ö½Ú
1308          * Êä    Èë         : com
1309          * Êä    ³ö         : ÎÞ
1310          *******************************************************************************/
1311          
1312          
1313          uchar Ds18b20ReadByte()
1314          {
1315   1        uchar byte, bi;
1316   1        uint i, j;  
1317   1        for(j=8; j>0; j--)
1318   1        {
1319   2          DSPORT = 0;//ÏÈ½«×ÜÏßÀ­µÍ1us
1320   2          i++;
1321   2          DSPORT = 1;//È»ºóÊÍ·Å×ÜÏß
1322   2          i++;
1323   2          i++;//ÑÓÊ±6usµÈ´ýÊý¾ÝÎÈ¶¨
1324   2          bi = DSPORT;   //¶ÁÈ¡Êý¾Ý£¬´Ó×îµÍÎ»¿ªÊ¼¶ÁÈ¡
1325   2          /*½«byte×óÒÆÒ»Î»£¬È»ºóÓëÉÏÓÒÒÆ7Î»ºóµÄbi£¬×¢ÒâÒÆ¶¯Ö®ºóÒÆµôÄÇÎ»²¹0¡£*/
1326   2          byte = (byte >> 1) | (bi << 7);             
1327   2          i = 4;    //¶ÁÈ¡ÍêÖ®ºóµÈ´ý48usÔÙ½Ó×Å¶ÁÈ¡ÏÂÒ»¸öÊý
1328   2          while(i--);
1329   2        }       
1330   1        return byte;
1331   1      }
1332          /*******************************************************************************
1333          * º¯ Êý Ãû         : Ds18b20ChangTemp
1334          * º¯Êý¹¦ÄÜ       : ÈÃ18b20¿ªÊ¼×ª»»ÎÂ¶È
1335          * Êä    Èë         : com
1336          * Êä    ³ö         : ÎÞ
1337          *******************************************************************************/
1338          
1339          void  Ds18b20ChangTemp()
1340          {
1341   1        Ds18b20Init();
1342   1        Delay1ms(1);
1343   1        Ds18b20WriteByte(0xcc);   //Ìø¹ýROM²Ù×÷ÃüÁî    
1344   1        Ds18b20WriteByte(0x44);     //ÎÂ¶È×ª»»ÃüÁî
1345   1      //  Delay1ms(100);  //µÈ´ý×ª»»³É¹¦£¬¶øÈç¹ûÄãÊÇÒ»Ö±Ë¢×ÅµÄ»°£¬¾Í²»ÓÃÕâ¸öÑÓÊ±ÁË
1346   1         
1347   1      }
1348          /*******************************************************************************
1349          * º¯ Êý Ãû         : Ds18b20ReadTempCom
1350          * º¯Êý¹¦ÄÜ       : ·¢ËÍ¶ÁÈ¡ÎÂ¶ÈÃüÁî
1351          * Êä    Èë         : com
C51 COMPILER V9.52.0.0   MAIN                                                              05/17/2015 12:17:18 PAGE 23  

1352          * Êä    ³ö         : ÎÞ
1353          *******************************************************************************/
1354          
1355          void  Ds18b20ReadTempCom()
1356          { 
1357   1      
1358   1        Ds18b20Init();
1359   1        Delay1ms(1);
1360   1        Ds18b20WriteByte(0xcc);  //Ìø¹ýROM²Ù×÷ÃüÁî
1361   1        Ds18b20WriteByte(0xbe);  //·¢ËÍ¶ÁÈ¡ÎÂ¶ÈÃüÁî
1362   1      }
1363          /*******************************************************************************
1364          * º¯ Êý Ãû         : Ds18b20ReadTemp
1365          * º¯Êý¹¦ÄÜ       : ¶ÁÈ¡ÎÂ¶È
1366          * Êä    Èë         : com
1367          * Êä    ³ö         : ÎÞ
1368          *******************************************************************************/
1369          
1370          int Ds18b20ReadTemp()
1371          {
1372   1        int temp = 0;
1373   1        uchar tmh, tml;
1374   1        Ds18b20ChangTemp();       //ÏÈÐ´Èë×ª»»ÃüÁî
1375   1        Ds18b20ReadTempCom();     //È»ºóµÈ´ý×ª»»Íêºó·¢ËÍ¶ÁÈ¡ÎÂ¶ÈÃüÁî
1376   1        tml = Ds18b20ReadByte();    //¶ÁÈ¡ÎÂ¶ÈÖµ¹²16Î»£¬ÏÈ¶ÁµÍ×Ö½Ú
1377   1        tmh = Ds18b20ReadByte();    //ÔÙ¶Á¸ß×Ö½Ú
1378   1        temp = tmh;
1379   1        temp <<= 8;
1380   1        temp |= tml;
1381   1        return temp;
1382   1      }
*** WARNING C316 IN LINE 1382 OF main.c: unterminated conditionals


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   3538    ----
   CONSTANT SIZE    =    151    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     55      25
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       1
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  3 WARNING(S),  0 ERROR(S)
